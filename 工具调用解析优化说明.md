# å·¥å…·è°ƒç”¨è§£æä¼˜åŒ–è¯´æ˜

## ğŸ› è§£å†³çš„é—®é¢˜

### é—®é¢˜ 1: åµŒå¥—æ‹¬å·è§£æé”™è¯¯

**åŸé—®é¢˜**:
```
Action: search_documents[{"query": {"bool": {"must": [...]}}}]
                         â†‘                              â†‘
                    åŸæ¥åœ¨è¿™é‡Œå°±åœæ­¢ â†’              åº”è¯¥åœ¨è¿™é‡Œåœæ­¢
```

åŸæ¥çš„æ­£åˆ™ `[^]]+` æ— æ³•å¤„ç†åµŒå¥—çš„ `[]` å’Œ `{}`ã€‚

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨**æ‹¬å·æ·±åº¦è®¡æ•°ç®—æ³•**

### é—®é¢˜ 2: æ— æ‹¬å·çš„å·¥å…·è°ƒç”¨

**åŸé—®é¢˜**:
```
Action: list_tables
Action: list_indices
```

è¿™äº›å·¥å…·ä¸éœ€è¦å‚æ•°ï¼Œå¯èƒ½æ²¡æœ‰æ‹¬å· `[]`ï¼ŒåŸæ¥çš„è§£ææ— æ³•è¯†åˆ«ã€‚

**è§£å†³æ–¹æ¡ˆ**: å…ˆåŒ¹é…å·¥å…·åï¼Œå†æ£€æŸ¥æ˜¯å¦æœ‰æ‹¬å·

---

## âœ… æ–°çš„è§£æé€»è¾‘

### æ”¯æŒçš„æ ¼å¼

#### æ ¼å¼ 1: æœ‰æ‹¬å·æœ‰è¾“å…¥
```
Action: search_documents[{"index": "logs", "query": {...}}]
        â†‘               â†‘                                  â†‘
      å·¥å…·å          å·¦æ‹¬å·                            å³æ‹¬å·
```

**è§£æç»“æœ**:
```go
ToolCall{
    Name: "search_documents",
    Input: `{"index": "logs", "query": {...}}`
}
```

#### æ ¼å¼ 2: æœ‰æ‹¬å·æ— è¾“å…¥
```
Action: list_tables[]
        â†‘          â†‘â†‘
      å·¥å…·å    ç©ºæ‹¬å·
```

**è§£æç»“æœ**:
```go
ToolCall{
    Name: "list_tables",
    Input: ""  // ç©ºå­—ç¬¦ä¸²
}
```

#### æ ¼å¼ 3: æ— æ‹¬å·
```
Action: list_indices
        â†‘
      å·¥å…·åï¼ˆåé¢æ²¡æœ‰æ‹¬å·ï¼‰
```

**è§£æç»“æœ**:
```go
ToolCall{
    Name: "list_indices",
    Input: ""  // ç©ºå­—ç¬¦ä¸²
}
```

---

## ğŸ”§ å®ç°ç»†èŠ‚

### æ ¸å¿ƒç®—æ³•

```go
func parseToolCall(content string) []*tools.ToolCall {
    // æ­¥éª¤ 1: æ‰¾åˆ°æ‰€æœ‰ "Action: toolName"
    actionPattern := regexp.MustCompile(`Action:\s*([a-zA-Z_-]+@?\w*)`)
    
    for each match {
        // æ­¥éª¤ 2: æå–å·¥å…·åç§°
        toolName := extractToolName()
        
        // æ­¥éª¤ 3: æ£€æŸ¥åé¢æ˜¯å¦æœ‰æ‹¬å·
        afterToolName := content[å·¥å…·åç§°ç»“æŸä½ç½®:]
        
        if ä»¥'['å¼€å¤´ {
            // æ­¥éª¤ 4a: æœ‰æ‹¬å·ï¼Œä½¿ç”¨æ·±åº¦è®¡æ•°æå–å†…å®¹
            input = extractBracketContent()
        } else {
            // æ­¥éª¤ 4b: æ— æ‹¬å·ï¼Œinput ä¸ºç©º
            input = ""
        }
        
        // æ­¥éª¤ 5: åˆ›å»º ToolCall
        toolCalls.append(ToolCall{Name: toolName, Input: input})
    }
}

// æ‹¬å·æ·±åº¦è®¡æ•°
func extractBracketContent(content, startPos) {
    depth := 0
    for each char {
        if char == '[': depth++
        if char == ']': depth--
        if depth == 0: return content[start:end]
    }
}
```

---

## ğŸ“ æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯• 1: æ— å‚æ•°å·¥å…·

**è¾“å…¥**:
```
Thought: æˆ‘éœ€è¦æŸ¥çœ‹æ‰€æœ‰ç´¢å¼•
Action: list_indices
```

**è§£æ**:
```go
ToolCall{Name: "list_indices", Input: ""}
```

âœ… **æ­£ç¡®è¯†åˆ«æ— æ‹¬å·çš„å·¥å…·è°ƒç”¨**

### æµ‹è¯• 2: ç©ºæ‹¬å·

**è¾“å…¥**:
```
Thought: åˆ—å‡ºæ‰€æœ‰è¡¨
Action: list_tables[]
```

**è§£æ**:
```go
ToolCall{Name: "list_tables", Input: ""}
```

âœ… **æ­£ç¡®å¤„ç†ç©ºæ‹¬å·**

### æµ‹è¯• 3: ç®€å•å‚æ•°

**è¾“å…¥**:
```
Action: get_index_mapping[logs]
```

**è§£æ**:
```go
ToolCall{Name: "get_index_mapping", Input: "logs"}
```

âœ… **æ­£ç¡®æå–ç®€å•å­—ç¬¦ä¸²å‚æ•°**

### æµ‹è¯• 4: JSON å‚æ•°

**è¾“å…¥**:
```
Action: search_documents[{"index": "logs", "size": 10}]
```

**è§£æ**:
```go
ToolCall{Name: "search_documents", Input: `{"index": "logs", "size": 10}`}
```

âœ… **æ­£ç¡®æå– JSON å‚æ•°**

### æµ‹è¯• 5: å¤æ‚åµŒå¥— JSON

**è¾“å…¥**:
```
Action: search_documents[{
  "index": "backend-vm_manager-2025.11.04",
  "query": {
    "bool": {
      "must": [
        {"term": {"M.keyword": "4103_jawqnr4i8rzh"}},
        {"term": {"L.keyword": "ERROR"}}
      ]
    }
  }
}]
```

**è§£æ**:
```go
ToolCall{
    Name: "search_documents",
    Input: `{"index": "backend-vm_manager-2025.11.04", "query": {"bool": {"must": [{"term": {"M.keyword": "4103_jawqnr4i8rzh"}}, {"term": {"L.keyword": "ERROR"}}]}}}`
}
```

âœ… **æ­£ç¡®å¤„ç†å¤šå±‚åµŒå¥—**

### æµ‹è¯• 6: å¤šä¸ªå·¥å…·è°ƒç”¨

**è¾“å…¥**:
```
Action: list_indices
Action: get_index_mapping[logs]
Action: search_documents[{"index": "logs"}]
```

**è§£æ**:
```go
[
    ToolCall{Name: "list_indices", Input: ""},
    ToolCall{Name: "get_index_mapping", Input: "logs"},
    ToolCall{Name: "search_documents", Input: `{"index": "logs"}`}
]
```

âœ… **æ­£ç¡®è§£æå¤šä¸ªæ··åˆæ ¼å¼çš„å·¥å…·è°ƒç”¨**

---

## ğŸ¯ åº”ç”¨åœºæ™¯

### SQL Agent

```
Thought: éœ€è¦æŸ¥çœ‹æ•°æ®åº“ä¸­çš„è¡¨
Action: list_tables          â† æ— æ‹¬å· âœ…

Thought: éœ€è¦äº†è§£ users è¡¨çš„ç»“æ„
Action: tables_schema[users] â† ç®€å•å‚æ•° âœ…

Thought: æ‰§è¡ŒæŸ¥è¯¢
Action: execute_sql[SELECT * FROM users LIMIT 10] â† å¤æ‚å‚æ•° âœ…
```

### Elasticsearch Agent

```
Thought: æŸ¥çœ‹æ‰€æœ‰ç´¢å¼•
Action: list_indices         â† æ— æ‹¬å· âœ…

Thought: æŸ¥çœ‹ç´¢å¼•æ˜ å°„
Action: get_index_mapping[logs] â† ç®€å•å‚æ•° âœ…

Thought: æœç´¢æ–‡æ¡£
Action: search_documents[{"index": "logs", "query": {"bool": {"must": [...]}}}] â† å¤æ‚ JSON âœ…
```

### é€šç”¨å·¥å…·

```
Action: calculator[1+2]      â† ç®€å•å‚æ•° âœ…
Action: averageDogWeight[border collie] â† æ–‡æœ¬å‚æ•° âœ…
```

---

## ğŸ” è§£ææµç¨‹å›¾

```
è¾“å…¥: Action: search_documents[{"a": [1, 2]}]
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ­£åˆ™åŒ¹é… "Action: toolName"     â”‚
â”‚    æ‰¾åˆ°: toolName = "search_documents" â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æ£€æŸ¥å·¥å…·ååé¢çš„å†…å®¹             â”‚
â”‚    å‰©ä½™: [{"a": [1, 2]}]            â”‚
â”‚    è·³è¿‡ç©ºç™½å: [{"a": [1, 2]}]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
       æ˜¯å¦ä»¥ '[' å¼€å¤´?
               â†“
       â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
       â†“              â†“
    æ˜¯ (æœ‰æ‹¬å·)    å¦ (æ— æ‹¬å·)
       â†“              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ extractBracketâ”‚  â”‚ input = ""  â”‚
â”‚ Content()     â”‚  â”‚             â”‚
â”‚               â”‚  â”‚             â”‚
â”‚ æ·±åº¦è®¡æ•°:     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ [ â†’ depth=1   â”‚
â”‚ { â†’ ä¸å˜      â”‚
â”‚ [ â†’ depth=2   â”‚
â”‚ ] â†’ depth=1   â”‚
â”‚ } â†’ ä¸å˜      â”‚
â”‚ ] â†’ depth=0 âœ“ â”‚
â”‚               â”‚
â”‚ è¿”å›: {"a":[1,2]}â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. åˆ›å»º ToolCall                    â”‚
â”‚    Name: "search_documents"         â”‚
â”‚    Input: `{"a": [1, 2]}`           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š æ‰€æœ‰æ”¯æŒçš„æ ¼å¼

| æ ¼å¼ | ç¤ºä¾‹ | è§£æç»“æœ |
|------|------|----------|
| æœ‰å‚æ•°ï¼ˆç®€å•ï¼‰ | `Action: tool[param]` | `Name="tool", Input="param"` |
| æœ‰å‚æ•°ï¼ˆJSONï¼‰ | `Action: tool[{"a":1}]` | `Name="tool", Input="{\"a\":1}"` |
| æœ‰å‚æ•°ï¼ˆåµŒå¥—JSONï¼‰ | `Action: tool[{"a":[1,2]}]` | `Name="tool", Input="{\"a\":[1,2]}"` |
| ç©ºæ‹¬å· | `Action: tool[]` | `Name="tool", Input=""` |
| æ— æ‹¬å· | `Action: tool` | `Name="tool", Input=""` |
| å¤šè¡Œæ ¼å¼ | `Action: tool[\n  {...}\n]` | `Name="tool", Input="..."` |

---

## âœ… æµ‹è¯•éªŒè¯

### æµ‹è¯•ä»£ç ï¼ˆå¯é€‰ï¼‰

åˆ›å»ºæµ‹è¯•æ–‡ä»¶éªŒè¯è§£æåŠŸèƒ½ï¼š

```go
// llm/types_test.go
func TestParseToolCall(t *testing.T) {
    tests := []struct {
        input    string
        expected []ToolCall
    }{
        // æ— æ‹¬å·
        {
            input: "Action: list_tables",
            expected: []ToolCall{{Name: "list_tables", Input: ""}},
        },
        // ç©ºæ‹¬å·
        {
            input: "Action: list_indices[]",
            expected: []ToolCall{{Name: "list_indices", Input: ""}},
        },
        // ç®€å•å‚æ•°
        {
            input: "Action: get_mapping[logs]",
            expected: []ToolCall{{Name: "get_mapping", Input: "logs"}},
        },
        // ç®€å• JSON
        {
            input: `Action: search[{"index": "logs"}]`,
            expected: []ToolCall{{Name: "search", Input: `{"index": "logs"}`}},
        },
        // å¤æ‚åµŒå¥— JSON
        {
            input: `Action: search[{"query": {"bool": {"must": [{"term": {"level": "ERROR"}}]}}}]`,
            expected: []ToolCall{{Name: "search", Input: `{"query": {"bool": {"must": [{"term": {"level": "ERROR"}}]}}}`}},
        },
    }
    
    for _, tt := range tests {
        result := parseToolCall(tt.input)
        // éªŒè¯ç»“æœ...
    }
}
```

---

## ğŸ¯ å®é™…ä½¿ç”¨åœºæ™¯

### Elasticsearch Agent æ‰§è¡Œæµç¨‹

```
Thought: æˆ‘éœ€è¦å…ˆæŸ¥çœ‹æœ‰å“ªäº›ç´¢å¼•
Action: list_indices                    â† æ— æ‹¬å· âœ…
Observation: logs-2024-11, logs-2024-10

Thought: æŸ¥çœ‹ logs-2024-11 çš„ç»“æ„
Action: get_index_mapping[logs-2024-11] â† ç®€å•å‚æ•° âœ…
Observation: {properties: {timestamp: {type: date}, ...}}

Thought: æœç´¢é”™è¯¯æ—¥å¿—
Action: search_documents[{
  "index": "logs-2024-11",
  "query": {
    "bool": {
      "must": [
        {"term": {"L.keyword": "ERROR"}}    â† åµŒå¥— JSON âœ…
      ]
    }
  }
}]
Observation: æ‰¾åˆ° 15 æ¡æ–‡æ¡£...
```

### SQL Agent æ‰§è¡Œæµç¨‹

```
Thought: éœ€è¦æŸ¥çœ‹æ‰€æœ‰è¡¨
Action: list_tables                     â† æ— æ‹¬å· âœ…
Observation: users, orders, products

Thought: æŸ¥çœ‹è¡¨ç»“æ„
Action: tables_schema[users, orders]    â† ç®€å•å‚æ•° âœ…
Observation: è¡¨ç»“æ„ä¿¡æ¯...

Thought: æ‰§è¡ŒæŸ¥è¯¢
Action: execute_sql[SELECT COUNT(*) FROM users] â† SQL å‚æ•° âœ…
Observation: æŸ¥è¯¢ç»“æœ...
```

---

## ğŸ”§ æ ¸å¿ƒæ”¹è¿›

### æ”¹è¿› 1: çµæ´»çš„æ ¼å¼æ”¯æŒ

```go
// åŸæ¥ï¼šåªæ”¯æŒ Action: tool[input]
re := regexp.MustCompile(`Action:\s*tool\[([^]]+)\]`)

// ç°åœ¨ï¼šæ”¯æŒæ‰€æœ‰æ ¼å¼
actionPattern := regexp.MustCompile(`Action:\s*([a-zA-Z_-]+@?\w*)`)
// ç„¶åæ£€æŸ¥åé¢æ˜¯å¦æœ‰æ‹¬å·
if strings.HasPrefix(trimmed, "[") {
    // æå–æ‹¬å·å†…å®¹
} else {
    // æ— æ‹¬å·ï¼Œinput ä¸ºç©º
}
```

### æ”¹è¿› 2: æ‹¬å·æ·±åº¦è®¡æ•°

```go
func extractBracketContent(content, startPos) {
    depth := 0
    for each char {
        if char == '[': depth++  // è¿›å…¥æ›´æ·±å±‚
        if char == ']': depth--  // é€€å‡ºä¸€å±‚
        if depth == 0: return content  // æ‰¾åˆ°åŒ¹é…
    }
}
```

**ä¼˜ç‚¹**:
- âœ… æ”¯æŒä»»æ„æ·±åº¦åµŒå¥—
- âœ… å¤„ç† `[{[{}]}]` ç­‰å¤æ‚ç»“æ„
- âœ… ä¸å—å†…å®¹å½±å“

---

## ğŸ“Š æ€§èƒ½å’Œå…¼å®¹æ€§

### æ€§èƒ½

- âœ… O(n) æ—¶é—´å¤æ‚åº¦ï¼ˆn = å†…å®¹é•¿åº¦ï¼‰
- âœ… å•æ¬¡éå†
- âœ… æ— é€’å½’è°ƒç”¨

### å…¼å®¹æ€§

**å‘åå…¼å®¹**:
- âœ… æ‰€æœ‰æ—§æ ¼å¼ä»ç„¶æœ‰æ•ˆ
- âœ… ä¸å½±å“ç°æœ‰å·¥å…·
- âœ… ä¸éœ€è¦ä¿®æ”¹æç¤ºè¯

**å‘å‰æ‰©å±•**:
- âœ… æ”¯æŒæ›´å¤æ‚çš„ JSON
- âœ… æ”¯æŒæ–°çš„å·¥å…·æ ¼å¼
- âœ… æ˜“äºæ·»åŠ æ–°è§„åˆ™

---

## âœ… ç¼–è¯‘éªŒè¯

```bash
âœ… go build -o jas-agent-server.exe cmd/server/main.go
   ç¼–è¯‘æˆåŠŸï¼
```

---

## ğŸŠ æ€»ç»“

**è§£æèƒ½åŠ›æå‡**:

| ç‰¹æ€§ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| ç®€å•å‚æ•° | âœ… | âœ… |
| JSON å‚æ•° | âš ï¸ éƒ¨åˆ†æ”¯æŒ | âœ… å®Œå…¨æ”¯æŒ |
| åµŒå¥— JSON | âŒ é”™è¯¯ | âœ… æ­£ç¡® |
| æ— æ‹¬å· | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ |
| ç©ºæ‹¬å· | âœ… | âœ… |
| å¤šå±‚åµŒå¥— | âŒ é”™è¯¯ | âœ… æ­£ç¡® |

**ç°åœ¨æ‰€æœ‰æ ¼å¼çš„å·¥å…·è°ƒç”¨éƒ½èƒ½æ­£ç¡®è§£æï¼**

ç‰¹åˆ«æ˜¯ **Elasticsearch Agent** çš„å¤æ‚æŸ¥è¯¢ DSL ç°åœ¨å¯ä»¥å®Œç¾å·¥ä½œäº†ï¼ğŸ‰

